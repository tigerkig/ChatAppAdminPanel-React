{"ast":null,"code":"import _regeneratorRuntime from\"E:/dev/admin_panel/LocalsAdminPanel/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"E:/dev/admin_panel/LocalsAdminPanel/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{v4 as uuidv4}from'uuid';import{createSlice}from'@reduxjs/toolkit';// utils\nimport axios from'../../utils/axios';// ----------------------------------------------------------------------\nfunction objFromArray(array){var key=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'_id';return array.reduce(function(accumulator,current){accumulator[current[key]]=current;return accumulator;},{});}var initialState={isLoading:false,error:false,contacts:{byId:{},allIds:[]},conversations:{byId:{},allIds:[]},activeConversationId:null,participants:[],recipients:[]};var slice=createSlice({name:'privatechat',initialState:initialState,reducers:{// START LOADING\nstartLoading:function startLoading(state){state.isLoading=true;},// HAS ERROR\nhasError:function hasError(state,action){state.isLoading=false;state.error=action.payload;},// GET CONTACT SSUCCESS\ngetContactsSuccess:function getContactsSuccess(state,action){var contacts=action.payload;state.contacts.byId=objFromArray(contacts);state.contacts.allIds=Object.keys(state.contacts.byId);},// GET CONVERSATIONS\ngetConversationsSuccess:function getConversationsSuccess(state,action){var conversations=action.payload;state.conversations.byId=objFromArray(conversations);state.conversations.allIds=Object.keys(state.conversations.byId);},// GET CONVERSATION\ngetConversationSuccess:function getConversationSuccess(state,action){var conversation=action.payload;if(conversation){state.conversations.byId[conversation._id]=conversation;if(!state.conversations.allIds.includes(conversation._id)){state.conversations.allIds.push(conversation._id);}}},// ON SEND MESSAGE\nonSendMessage:function onSendMessage(state,action){var conversation=action.payload;var conversationId=conversation.conversationId,messageId=conversation.messageId,message=conversation.message,imgs=conversation.imgs,senderId=conversation.senderId,senderName=conversation.senderName,receiverId=conversation.receiverId,messageType=conversation.messageType;var newMessage={sender_id:senderId,sender_name:senderName,_id:messageId,chat_id:conversationId,message:message,receiver_id:receiverId,message_type:messageType,imgs:imgs,createdAt:Date.now()};state.conversations.byId[conversationId].messages.push(newMessage);},markConversationAsReadSuccess:function markConversationAsReadSuccess(state,action){var conversationId=action.payload.conversationId;var conversation=state.conversations.byId[conversationId];if(conversation){conversation.lastMessage.unread_count=0;}},// GET PARTICIPANTS\ngetParticipantsSuccess:function getParticipantsSuccess(state,action){var participants=action.payload;state.participants=participants;},// RESET ACTIVE CONVERSATION\nresetActiveConversation:function resetActiveConversation(state){state.activeConversationId=null;},getActiveConversationIdSuccess:function getActiveConversationIdSuccess(state,action){var activeConversationId=action.payload;state.activeConversationId=activeConversationId;},addRecipients:function addRecipients(state,action){var recipients=action.payload;state.recipients=recipients;}}});// Reducer\nexport default slice.reducer;// Actions\nvar _slice$actions=slice.actions,addRecipients=_slice$actions.addRecipients,onSendMessage=_slice$actions.onSendMessage,resetActiveConversation=_slice$actions.resetActiveConversation;// ---------------------------------------------------------------------\n// ON SEND MESSAGE\nexport{addRecipients,onSendMessage,resetActiveConversation};export function onConnectChat(userOne,userTwo,lastMessage){return/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(dispatch){var response,responseData,newMessage;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:dispatch(slice.actions.startLoading());_context.prev=1;_context.next=4;return axios.post('/conversions/create',{user_one:userOne,user_two:userTwo,lastMessage:lastMessage});case 4:response=_context.sent;responseData=response.data;if(!responseData.error){_context.next=10;break;}dispatch(slice.actions.hasError(response.data));_context.next=15;break;case 10:if(!responseData.new){_context.next=14;break;}_context.next=13;return axios.post('/message/send',{messageId:uuidv4(),message:lastMessage,senderId:userOne,receiverId:userTwo,chatId:responseData.data._id,messageType:0,imgs:[]});case 13:newMessage=_context.sent;case 14:dispatch(slice.actions.getActiveConversationIdSuccess(responseData.data._id));case 15:_context.next=20;break;case 17:_context.prev=17;_context.t0=_context[\"catch\"](1);dispatch(slice.actions.hasError(_context.t0));case 20:case\"end\":return _context.stop();}}},_callee,null,[[1,17]]);}));return function(_x){return _ref.apply(this,arguments);};}();}// ----------------------------------------------------------------------\nexport function getContacts(){return/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(dispatch){var response;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:dispatch(slice.actions.startLoading());_context2.prev=1;_context2.next=4;return axios.get('/conversions/contacts');case 4:response=_context2.sent;dispatch(slice.actions.getContactsSuccess(response.data.contacts));_context2.next=11;break;case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](1);dispatch(slice.actions.hasError(_context2.t0));case 11:case\"end\":return _context2.stop();}}},_callee2,null,[[1,8]]);}));return function(_x2){return _ref2.apply(this,arguments);};}();}// ----------------------------------------------------------------------\nexport function getConversations(){return/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(dispatch){var response;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:dispatch(slice.actions.startLoading());_context3.prev=1;_context3.next=4;return axios.post('/conversions/conversations');case 4:response=_context3.sent;dispatch(slice.actions.getConversationsSuccess(response.data.conversations));_context3.next=11;break;case 8:_context3.prev=8;_context3.t0=_context3[\"catch\"](1);dispatch(slice.actions.hasError(_context3.t0));case 11:case\"end\":return _context3.stop();}}},_callee3,null,[[1,8]]);}));return function(_x3){return _ref3.apply(this,arguments);};}();}// ----------------------------------------------------------------------\nexport function getConversation(chatId){return/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(dispatch){var response;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:dispatch(slice.actions.startLoading());_context4.prev=1;_context4.next=4;return axios.post('/conversions/conversation',{chat_id:chatId});case 4:response=_context4.sent;dispatch(slice.actions.getConversationSuccess(response.data.conversation));_context4.next=11;break;case 8:_context4.prev=8;_context4.t0=_context4[\"catch\"](1);dispatch(slice.actions.hasError(_context4.t0));case 11:case\"end\":return _context4.stop();}}},_callee4,null,[[1,8]]);}));return function(_x4){return _ref4.apply(this,arguments);};}();}// ----------------------------------------------------------------------\nexport function markConversationAsRead(conversationId){return/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(dispatch){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:dispatch(slice.actions.startLoading());_context5.prev=1;_context5.next=4;return axios.get('/chat/conversation/mark-as-seen',{params:{conversationId:conversationId}});case 4:dispatch(slice.actions.markConversationAsReadSuccess({conversationId:conversationId}));_context5.next=10;break;case 7:_context5.prev=7;_context5.t0=_context5[\"catch\"](1);dispatch(slice.actions.hasError(_context5.t0));case 10:case\"end\":return _context5.stop();}}},_callee5,null,[[1,7]]);}));return function(_x5){return _ref5.apply(this,arguments);};}();}// ----------------------------------------------------------------------\nexport function getParticipants(conversationKey){return/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(dispatch){var response;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:dispatch(slice.actions.startLoading());_context6.prev=1;_context6.next=4;return axios.get('/chat/participants',{params:{conversationKey:conversationKey}});case 4:response=_context6.sent;dispatch(slice.actions.getParticipantsSuccess(response.data.participants));_context6.next=11;break;case 8:_context6.prev=8;_context6.t0=_context6[\"catch\"](1);dispatch(slice.actions.hasError(_context6.t0));case 11:case\"end\":return _context6.stop();}}},_callee6,null,[[1,8]]);}));return function(_x6){return _ref6.apply(this,arguments);};}();}","map":{"version":3,"sources":["E:/dev/admin_panel/LocalsAdminPanel/src/redux/slices/privatechat.js"],"names":["v4","uuidv4","createSlice","axios","objFromArray","array","key","reduce","accumulator","current","initialState","isLoading","error","contacts","byId","allIds","conversations","activeConversationId","participants","recipients","slice","name","reducers","startLoading","state","hasError","action","payload","getContactsSuccess","Object","keys","getConversationsSuccess","getConversationSuccess","conversation","_id","includes","push","onSendMessage","conversationId","messageId","message","imgs","senderId","senderName","receiverId","messageType","newMessage","sender_id","sender_name","chat_id","receiver_id","message_type","createdAt","Date","now","messages","markConversationAsReadSuccess","lastMessage","unread_count","getParticipantsSuccess","resetActiveConversation","getActiveConversationIdSuccess","addRecipients","reducer","actions","onConnectChat","userOne","userTwo","dispatch","post","user_one","user_two","response","responseData","data","new","chatId","getContacts","get","getConversations","getConversation","markConversationAsRead","params","getParticipants","conversationKey"],"mappings":"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","sourcesContent":["import { v4 as uuidv4 } from 'uuid';\nimport { createSlice } from '@reduxjs/toolkit';\n// utils\nimport axios from '../../utils/axios';\n\n// ----------------------------------------------------------------------\n\nfunction objFromArray(array, key = '_id') {\n  return array.reduce((accumulator, current) => {\n    accumulator[current[key]] = current;\n    return accumulator;\n  }, {});\n}\n\nconst initialState = {\n  isLoading: false,\n  error: false,\n  contacts: { byId: {}, allIds: [] },\n  conversations: { byId: {}, allIds: [] },\n  activeConversationId: null,\n  participants: [],\n  recipients: []\n};\n\nconst slice = createSlice({\n  name: 'privatechat',\n  initialState,\n  reducers: {\n    // START LOADING\n    startLoading(state) {\n      state.isLoading = true;\n    },\n\n    // HAS ERROR\n    hasError(state, action) {\n      state.isLoading = false;\n      state.error = action.payload;\n    },\n\n    // GET CONTACT SSUCCESS\n    getContactsSuccess(state, action) {\n      const contacts = action.payload;\n      state.contacts.byId = objFromArray(contacts);\n      state.contacts.allIds = Object.keys(state.contacts.byId);\n    },\n\n    // GET CONVERSATIONS\n    getConversationsSuccess(state, action) {\n      const conversations = action.payload;\n\n      state.conversations.byId = objFromArray(conversations);\n      state.conversations.allIds = Object.keys(state.conversations.byId);\n    },\n\n    // GET CONVERSATION\n    getConversationSuccess(state, action) {\n      const conversation = action.payload;\n      if (conversation) {\n        state.conversations.byId[conversation._id] = conversation;\n        if (!state.conversations.allIds.includes(conversation._id)) {\n          state.conversations.allIds.push(conversation._id);\n        }\n      }\n    },\n\n    // ON SEND MESSAGE\n    onSendMessage(state, action) {\n      const conversation = action.payload;\n      const { conversationId, messageId, message, imgs, senderId, senderName, receiverId, messageType } = conversation;\n\n      const newMessage = {\n        sender_id: senderId,\n        sender_name: senderName,\n        _id: messageId,\n        chat_id: conversationId,\n        message,\n        receiver_id: receiverId,\n        message_type: messageType,\n        imgs,\n        createdAt: Date.now()\n      };\n\n      state.conversations.byId[conversationId].messages.push(newMessage);\n    },\n\n    markConversationAsReadSuccess(state, action) {\n      const { conversationId } = action.payload;\n      const conversation = state.conversations.byId[conversationId];\n      if (conversation) {\n        conversation.lastMessage.unread_count = 0;\n      }\n    },\n\n    // GET PARTICIPANTS\n    getParticipantsSuccess(state, action) {\n      const participants = action.payload;\n      state.participants = participants;\n    },\n\n    // RESET ACTIVE CONVERSATION\n    resetActiveConversation(state) {\n      state.activeConversationId = null;\n    },\n\n    getActiveConversationIdSuccess(state, action) {\n      const activeConversationId = action.payload;\n      state.activeConversationId = activeConversationId;\n    },\n\n    addRecipients(state, action) {\n      const recipients = action.payload;\n      state.recipients = recipients;\n    }\n  }\n});\n\n// Reducer\nexport default slice.reducer;\n\n// Actions\nexport const { addRecipients, onSendMessage, resetActiveConversation } = slice.actions;\n\n// ---------------------------------------------------------------------\n// ON SEND MESSAGE\nexport function onConnectChat(userOne, userTwo, lastMessage) {\n  return async (dispatch) => {\n    dispatch(slice.actions.startLoading());\n    try {\n      const response = await axios.post('/conversions/create', {\n        user_one: userOne,\n        user_two: userTwo,\n        lastMessage\n      });\n      const responseData = response.data;\n      if (responseData.error) {\n        dispatch(slice.actions.hasError(response.data));\n      } else {\n        if (responseData.new) {\n          const newMessage = await axios.post('/message/send', {\n            messageId: uuidv4(),\n            message: lastMessage,\n            senderId: userOne,\n            receiverId: userTwo,\n            chatId: responseData.data._id,\n            messageType: 0,\n            imgs: []\n          });\n        }\n        dispatch(slice.actions.getActiveConversationIdSuccess(responseData.data._id));\n      }\n    } catch (error) {\n      dispatch(slice.actions.hasError(error));\n    }\n  };\n}\n\n// ----------------------------------------------------------------------\n\nexport function getContacts() {\n  return async (dispatch) => {\n    dispatch(slice.actions.startLoading());\n    try {\n      const response = await axios.get('/conversions/contacts');\n      dispatch(slice.actions.getContactsSuccess(response.data.contacts));\n    } catch (error) {\n      dispatch(slice.actions.hasError(error));\n    }\n  };\n}\n\n// ----------------------------------------------------------------------\n\nexport function getConversations() {\n  return async (dispatch) => {\n    dispatch(slice.actions.startLoading());\n    try {\n      const response = await axios.post('/conversions/conversations');\n      dispatch(slice.actions.getConversationsSuccess(response.data.conversations));\n    } catch (error) {\n      dispatch(slice.actions.hasError(error));\n    }\n  };\n}\n\n// ----------------------------------------------------------------------\n\nexport function getConversation(chatId) {\n  return async (dispatch) => {\n    dispatch(slice.actions.startLoading());\n    try {\n      const response = await axios.post('/conversions/conversation', {\n        chat_id: chatId\n      });\n      dispatch(slice.actions.getConversationSuccess(response.data.conversation));\n    } catch (error) {\n      dispatch(slice.actions.hasError(error));\n    }\n  };\n}\n\n// ----------------------------------------------------------------------\n\nexport function markConversationAsRead(conversationId) {\n  return async (dispatch) => {\n    dispatch(slice.actions.startLoading());\n    try {\n      await axios.get('/chat/conversation/mark-as-seen', {\n        params: { conversationId }\n      });\n      dispatch(slice.actions.markConversationAsReadSuccess({ conversationId }));\n    } catch (error) {\n      dispatch(slice.actions.hasError(error));\n    }\n  };\n}\n\n// ----------------------------------------------------------------------\n\nexport function getParticipants(conversationKey) {\n  return async (dispatch) => {\n    dispatch(slice.actions.startLoading());\n    try {\n      const response = await axios.get('/chat/participants', {\n        params: { conversationKey }\n      });\n      dispatch(slice.actions.getParticipantsSuccess(response.data.participants));\n    } catch (error) {\n      dispatch(slice.actions.hasError(error));\n    }\n  };\n}\n"]},"metadata":{},"sourceType":"module"}